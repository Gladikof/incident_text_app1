<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Logs - Service Desk</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">Service Desk</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="tickets.html" class="nav-link">Tickets</a></li>
            <li><a href="board.html" class="nav-link">Board</a></li>
            <li><a href="analytics.html" class="nav-link">Analytics</a></li>
            <li><a href="ml-logs.html" class="nav-link active">ML Logs</a></li>
            <li id="ml-training-nav" style="display: none;"><a href="ml-training.html" class="nav-link">ML Training</a></li>
            <li id="admin-nav-users" style="display: none;"><a href="admin-users.html" class="nav-link">Users</a></li>
            <li id="admin-nav-departments" style="display: none;"><a href="admin-departments.html" class="nav-link">Departments</a></li>
            <li><a href="#" class="nav-link" id="user-name">Loading...</a></li>
            <li><a href="#" class="nav-link" id="logout-btn">–í–∏—Ö—ñ–¥</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1 style="margin-bottom: 1.5rem;">ML / LLM Logs</h1>

        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
            <strong>–ù–∞–≤—á–∞–ª—å–Ω–∞ –≤–∏–±—ñ—Ä–∫–∞:</strong> –∫–æ–∂–Ω–∞ —Ä—É—á–Ω–∞ –∑–º—ñ–Ω–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—Ç—Ä–∞–ø–ª—è—î –¥–æ
            <code>training/data/priority_feedback.csv</code>. –ê–Ω–∞–ª—ñ—Ç–∏–∫–∏ –º–æ–∂—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª –¥–ª—è
            –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è ML —Ç–∞ –∞–∫—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—ñ–¥–∫–∞–∑–æ–∫ LLM.
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;">–§—ñ–ª—å—Ç—Ä–∏</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                <div>
                    <label for="filter-ticket-id" class="form-label">Ticket ID</label>
                    <input type="number" id="filter-ticket-id" class="form-input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 42">
                </div>
                <div>
                    <label for="filter-limit" class="form-label">Limit</label>
                    <input type="number" id="filter-limit" class="form-input" value="50" min="1" max="500">
                </div>
                <button id="apply-filters" class="btn btn-primary">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="logs-stats">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>–û—Å—Ç–∞–Ω–Ω—ñ –∑–∞–ø–∏—Å–∏</h2>
                <span id="logs-count" class="badge badge-status">0 –∑–∞–ø–∏—Å—ñ–≤</span>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ticket</th>
                            <th>ML ‚ûú LLM ‚ûú Final</th>
                            <th>–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–ê–≤—Ç–æ—Ä</th>
                            <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table">
                        <tr><td colspan="7" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/api.v2.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        let currentUser = null;

        async function loadCurrentUser() {
            currentUser = await api.getMe();
            document.getElementById('user-name').textContent = currentUser.email;
            if (currentUser.role === 'ADMIN') {
                document.getElementById('admin-nav-users').style.display = 'block';
                document.getElementById('admin-nav-departments').style.display = 'block';
            }

            // Show ML Training for ADMIN only
            if (currentUser.role === 'ADMIN') {
                document.getElementById('ml-training-nav').style.display = 'block';
            }
        }

        function formatPriority(p) {
            return p ? `<span class="badge badge-priority">${p}</span>` : '<span class="badge badge-muted">‚Äî</span>';
        }

        function formatConfidence(ml, llm) {
            const mlText = ml !== null && ml !== undefined ? (ml * 100).toFixed(0) + '%' : '‚Äî';
            const llmText = llm !== null && llm !== undefined ? (llm * 100).toFixed(0) + '%' : '‚Äî';
            return `<div>ML: ${mlText}</div><div>LLM: ${llmText}</div>`;
        }

        function renderStats(logs) {
            if (!logs.length) {
                document.getElementById('logs-stats').innerHTML = '<p>–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
                return;
            }

            const manualOverrides = logs.filter(log => log.priority_feedback_reason);
            const mismatchCount = logs.filter(log => log.triage_reason === 'LLM_PRIORITY_MISMATCH');
            const latestFeedback = manualOverrides[0]?.priority_feedback_recorded_at;

            const cardStyle = 'background: var(--dark-lighter); border-radius: 12px; padding: 1rem;';
            const valueStyle = 'font-size: 2rem; font-weight: 700;';
            const labelStyle = 'color: var(--gray); margin-top: 0.25rem; font-size: 0.9rem;';

            document.getElementById('logs-stats').innerHTML = `
                <div style="display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div style="${cardStyle}">
                        <div style="${valueStyle}">${logs.length}</div>
                        <div style="${labelStyle}">–ó–∞–ø–∏—Å—ñ–≤ —É –≤–∏–±—ñ—Ä—Ü—ñ</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle}">${manualOverrides.length}</div>
                        <div style="${labelStyle}">–†—É—á–Ω–∏—Ö –∫–æ—Ä–µ–∫—Ü—ñ–π</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle}">${mismatchCount.length}</div>
                        <div style="${labelStyle}">LLM vs ML —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle}">${latestFeedback ? new Date(latestFeedback).toLocaleString() : '‚Äî'}</div>
                        <div style="${labelStyle}">–û—Å—Ç–∞–Ω–Ω—ñ–π —Ñ—ñ–¥–±–µ–∫</div>
                    </div>
                </div>
            `;
        }

        async function loadLogs() {
            const limit = parseInt(document.getElementById('filter-limit').value, 10) || 50;
            const ticketIdValue = document.getElementById('filter-ticket-id').value;
            const ticketId = ticketIdValue ? parseInt(ticketIdValue, 10) : null;

            const tableBody = document.getElementById('logs-table');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';

            try {
                const logs = await api.getMlLogs({ limit, ticketId });
                document.getElementById('logs-count').textContent = `${logs.length} –∑–∞–ø–∏—Å—ñ–≤`;
                renderStats(logs);

                if (!logs.length) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</td></tr>';
                    return;
                }

                tableBody.innerHTML = logs.map(log => {
                    const ticketLink = `<a href="tickets.html#ticket-${log.ticket_id}">INC-${String(log.ticket_id).padStart(4, '0')}</a>`;
                    const summary = `${formatPriority(log.priority_predicted)} ‚ûú ${formatPriority(log.priority_llm_predicted)} ‚ûú ${formatPriority(log.priority_final)}`;
                    const reason = log.priority_feedback_reason ? `<div>${log.priority_feedback_reason}</div>` : '<span class="badge badge-muted">‚Äî</span>';
                    const author = log.priority_feedback_author ? log.priority_feedback_author.email : '‚Äî';
                    const created = new Date(log.created_at).toLocaleString();

                    return `
                        <tr>
                            <td>${log.id}</td>
                            <td>
                                ${ticketLink}
                                <div style="font-size: 0.8rem; color: var(--gray);">${log.ticket_title || ''}</div>
                            </td>
                            <td>${summary}</td>
                            <td>${formatConfidence(log.priority_confidence, log.priority_llm_confidence)}</td>
                            <td>${reason}</td>
                            <td>${author}</td>
                            <td>${created}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--danger);">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</td></tr>`;
                document.getElementById('logs-count').textContent = '0 –∑–∞–ø–∏—Å—ñ–≤';
                document.getElementById('logs-stats').innerHTML = '<p style="color: var(--danger);">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ.</p>';
            }
        }

        document.getElementById('apply-filters').addEventListener('click', loadLogs);
        document.getElementById('logout-btn').addEventListener('click', (event) => {
            event.preventDefault();
            api.logout();
            window.location.href = 'login.html';
        });

        (async function init() {
            try {
                await loadCurrentUser();
                await loadLogs();
            } catch (error) {
                console.error('ML log page init failed:', error);
            }
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Logs - Service Desk</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">Service Desk</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="tickets.html" class="nav-link">Tickets</a></li>
            <li><a href="board.html" class="nav-link">Board</a></li>
            <li><a href="analytics.html" class="nav-link">Analytics</a></li>
            <li><a href="ml-logs.html" class="nav-link active">ML Logs</a></li>
            <li id="ml-training-nav" style="display: none;"><a href="ml-training.html" class="nav-link">ML Training</a></li>
            <li id="admin-nav-users" style="display: none;"><a href="admin-users.html" class="nav-link">Users</a></li>
            <li id="admin-nav-departments" style="display: none;"><a href="admin-departments.html" class="nav-link">Departments</a></li>
            <li><a href="#" class="nav-link" id="user-name">Loading...</a></li>
            <li><a href="#" class="nav-link" id="logout-btn">–í–∏—Ö—ñ–¥</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1 style="margin-bottom: 1.5rem;">ML / LLM Logs</h1>

        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
            <strong>–ù–∞–≤—á–∞–ª—å–Ω–∞ –≤–∏–±—ñ—Ä–∫–∞:</strong> –∫–æ–∂–Ω–∞ —Ä—É—á–Ω–∞ –∑–º—ñ–Ω–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—Ç—Ä–∞–ø–ª—è—î –¥–æ
            <code>training/data/priority_feedback.csv</code>. –ê–Ω–∞–ª—ñ—Ç–∏–∫–∏ –º–æ–∂—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª –¥–ª—è
            –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è ML —Ç–∞ –∞–∫—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—ñ–¥–∫–∞–∑–æ–∫ LLM.
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;">–§—ñ–ª—å—Ç—Ä–∏</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                <div>
                    <label for="filter-ticket-id" class="form-label">Ticket ID</label>
                    <input type="number" id="filter-ticket-id" class="form-input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 42">
                </div>
                <div>
                    <label for="filter-limit" class="form-label">Limit</label>
                    <input type="number" id="filter-limit" class="form-input" value="50" min="1" max="500">
                </div>
                <div>
                    <label for="filter-feedback-type" class="form-label">Feedback Type</label>
                    <select id="filter-feedback-type" class="form-input">
                        <option value="all">–í—Å—ñ</option>
                        <option value="explicit">–¢—ñ–ª—å–∫–∏ –∑ –∫–æ—Ä–µ–∫—Ç—É–≤–∞–Ω–Ω—è–º</option>
                        <option value="implicit">–¢—ñ–ª—å–∫–∏ –±–µ–∑ –∫–æ—Ä–µ–∫—Ç—É–≤–∞–Ω–Ω—è</option>
                    </select>
                </div>
                <div>
                    <label for="filter-mismatch" class="form-label">ML vs LLM</label>
                    <select id="filter-mismatch" class="form-input">
                        <option value="all">–í—Å—ñ</option>
                        <option value="match">–°–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å</option>
                        <option value="mismatch">–†–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ</option>
                    </select>
                </div>
                <button id="apply-filters" class="btn btn-primary">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
                <button id="export-csv" class="btn btn-secondary">üì• Export CSV</button>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="logs-stats">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>–û—Å—Ç–∞–Ω–Ω—ñ –∑–∞–ø–∏—Å–∏</h2>
                <span id="logs-count" class="badge badge-status">0 –∑–∞–ø–∏—Å—ñ–≤</span>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ticket</th>
                            <th>Priority: ML ‚ûú LLM ‚ûú Final</th>
                            <th>–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å</th>
                            <th>Ensemble</th>
                            <th>Triage</th>
                            <th>Feedback</th>
                            <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table">
                        <tr><td colspan="8" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/api.v2.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        let currentUser = null;

        async function loadCurrentUser() {
            currentUser = await api.getMe();
            document.getElementById('user-name').textContent = currentUser.email;
            if (currentUser.role === 'ADMIN') {
                document.getElementById('admin-nav-users').style.display = 'block';
                document.getElementById('admin-nav-departments').style.display = 'block';
            }

            // Show ML Training for ADMIN only
            if (currentUser.role === 'ADMIN') {
                document.getElementById('ml-training-nav').style.display = 'block';
            }
        }

        function formatPriority(p) {
            return p ? `<span class="badge badge-priority">${p}</span>` : '<span class="badge badge-muted">‚Äî</span>';
        }

        function formatConfidence(ml, llm) {
            const mlText = ml !== null && ml !== undefined ? (ml * 100).toFixed(0) + '%' : '‚Äî';
            const llmText = llm !== null && llm !== undefined ? (llm * 100).toFixed(0) + '%' : '‚Äî';
            return `<div>ML: ${mlText}</div><div>LLM: ${llmText}</div>`;
        }

        function renderStats(logs) {
            if (!logs.length) {
                document.getElementById('logs-stats').innerHTML = '<p>–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
                return;
            }

            const explicitFeedback = logs.filter(log => log.priority_feedback_reason);
            const implicitFeedback = logs.filter(log => !log.priority_feedback_reason && log.priority_final === log.priority_predicted);
            const mismatchCount = logs.filter(log => log.triage_reason === 'LLM_PRIORITY_MISMATCH');
            const mlAccurate = logs.filter(log => log.priority_final === log.priority_predicted);
            const llmAccurate = logs.filter(log => log.priority_final === log.priority_llm_predicted);
            const latestFeedback = explicitFeedback[0]?.priority_feedback_recorded_at;

            const mlAccuracy = logs.length > 0 ? ((mlAccurate.length / logs.length) * 100).toFixed(1) : 0;
            const llmAccuracy = logs.length > 0 ? ((llmAccurate.length / logs.length) * 100).toFixed(1) : 0;

            const cardStyle = 'background: var(--dark-lighter); border-radius: 12px; padding: 1rem;';
            const valueStyle = 'font-size: 2rem; font-weight: 700;';
            const labelStyle = 'color: var(--gray); margin-top: 0.25rem; font-size: 0.9rem;';

            document.getElementById('logs-stats').innerHTML = `
                <div style="display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div style="${cardStyle}">
                        <div style="${valueStyle}">${logs.length}</div>
                        <div style="${labelStyle}">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle} color: var(--warning);">${explicitFeedback.length}</div>
                        <div style="${labelStyle}">–Ø–≤–Ω–∏—Ö –∫–æ—Ä–µ–∫—Ç—É–≤–∞–Ω—å</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle} color: var(--success);">${implicitFeedback.length}</div>
                        <div style="${labelStyle}">–ù–µ—è–≤–Ω–∏—Ö –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—å</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle} color: var(--danger);">${mismatchCount.length}</div>
                        <div style="${labelStyle}">ML/LLM —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle} color: var(--primary);">${mlAccuracy}%</div>
                        <div style="${labelStyle}">ML —Ç–æ—á–Ω—ñ—Å—Ç—å</div>
                    </div>
                    <div style="${cardStyle}">
                        <div style="${valueStyle} color: var(--info);">${llmAccuracy}%</div>
                        <div style="${labelStyle}">LLM —Ç–æ—á–Ω—ñ—Å—Ç—å</div>
                    </div>
                </div>
            `;
        }

        function formatTriageReason(reason) {
            const reasonMap = {
                'LOW_PRIORITY_CONF': '–ù–∏–∑—å–∫–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å ML',
                'LOW_CATEGORY_CONF': '–ù–∏–∑—å–∫–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó',
                'ML_DISABLED': 'ML –≤–∏–º–∫–Ω–µ–Ω–æ',
                'MANUAL_FLAG': '–†—É—á–Ω–∏–π —Ç—Ä—ñ–∞–∂',
                'LLM_PRIORITY_MISMATCH': 'ML/LLM —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å'
            };
            return reasonMap[reason] || reason || '‚Äî';
        }

        async function loadLogs() {
            const limit = parseInt(document.getElementById('filter-limit').value, 10) || 50;
            const ticketIdValue = document.getElementById('filter-ticket-id').value;
            const ticketId = ticketIdValue ? parseInt(ticketIdValue, 10) : null;
            const feedbackType = document.getElementById('filter-feedback-type').value;
            const mismatchFilter = document.getElementById('filter-mismatch').value;

            const tableBody = document.getElementById('logs-table');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';

            try {
                let logs = await api.getMlLogs({ limit: 500, ticketId });

                // Client-side filtering
                if (feedbackType === 'explicit') {
                    logs = logs.filter(log => log.priority_feedback_reason);
                } else if (feedbackType === 'implicit') {
                    logs = logs.filter(log => !log.priority_feedback_reason && log.priority_final === log.priority_predicted);
                }

                if (mismatchFilter === 'match') {
                    logs = logs.filter(log => log.priority_predicted === log.priority_llm_predicted);
                } else if (mismatchFilter === 'mismatch') {
                    logs = logs.filter(log => log.priority_predicted !== log.priority_llm_predicted);
                }

                // Apply limit after filtering
                logs = logs.slice(0, limit);

                document.getElementById('logs-count').textContent = `${logs.length} –∑–∞–ø–∏—Å—ñ–≤`;
                renderStats(logs);

                if (!logs.length) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</td></tr>';
                    return;
                }

                tableBody.innerHTML = logs.map(log => {
                    const ticketLink = `<a href="tickets.html#ticket-${log.ticket_id}">INC-${String(log.ticket_id).padStart(4, '0')}</a>`;
                    const summary = `${formatPriority(log.priority_predicted)} ‚ûú ${formatPriority(log.priority_llm_predicted)} ‚ûú ${formatPriority(log.priority_final)}`;

                    // Ensemble strategy display
                    const ensembleInfo = log.ensemble_strategy
                        ? `<div style="font-size: 0.8rem;">${log.ensemble_strategy}</div>`
                        : '<span class="badge badge-muted">‚Äî</span>';

                    // Triage reason
                    const triageReason = log.triage_reason
                        ? `<span class="badge badge-warning" title="${log.triage_reason}">${formatTriageReason(log.triage_reason)}</span>`
                        : '<span class="badge badge-success">Auto</span>';

                    // Feedback info
                    const feedbackInfo = log.priority_feedback_reason
                        ? `<div style="font-size: 0.85rem;">${log.priority_feedback_reason}</div>
                           <div style="font-size: 0.75rem; color: var(--gray);">${log.priority_feedback_author ? log.priority_feedback_author.email : '‚Äî'}</div>`
                        : '<span class="badge badge-success" title="–ù–µ—è–≤–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è">‚úì Implicit</span>';

                    const created = new Date(log.created_at).toLocaleString();

                    return `
                        <tr>
                            <td>${log.id}</td>
                            <td>
                                ${ticketLink}
                                <div style="font-size: 0.8rem; color: var(--gray);">${(log.ticket_title || '').substring(0, 40)}${log.ticket_title && log.ticket_title.length > 40 ? '...' : ''}</div>
                            </td>
                            <td>${summary}</td>
                            <td style="font-size: 0.85rem;">${formatConfidence(log.priority_confidence, log.priority_llm_confidence)}</td>
                            <td>${ensembleInfo}</td>
                            <td>${triageReason}</td>
                            <td>${feedbackInfo}</td>
                            <td style="font-size: 0.85rem;">${created}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: var(--danger);">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</td></tr>`;
                document.getElementById('logs-count').textContent = '0 –∑–∞–ø–∏—Å—ñ–≤';
                document.getElementById('logs-stats').innerHTML = '<p style="color: var(--danger);">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ.</p>';
            }
        }

        function exportToCSV() {
            const limit = parseInt(document.getElementById('filter-limit').value, 10) || 50;
            const ticketIdValue = document.getElementById('filter-ticket-id').value;
            const ticketId = ticketIdValue ? parseInt(ticketIdValue, 10) : null;

            api.getMlLogs({ limit: 500, ticketId }).then(logs => {
                // Apply filters
                const feedbackType = document.getElementById('filter-feedback-type').value;
                const mismatchFilter = document.getElementById('filter-mismatch').value;

                if (feedbackType === 'explicit') {
                    logs = logs.filter(log => log.priority_feedback_reason);
                } else if (feedbackType === 'implicit') {
                    logs = logs.filter(log => !log.priority_feedback_reason && log.priority_final === log.priority_predicted);
                }

                if (mismatchFilter === 'match') {
                    logs = logs.filter(log => log.priority_predicted === log.priority_llm_predicted);
                } else if (mismatchFilter === 'mismatch') {
                    logs = logs.filter(log => log.priority_predicted !== log.priority_llm_predicted);
                }

                logs = logs.slice(0, limit);

                // Build CSV
                const headers = ['ID', 'Ticket ID', 'Title', 'ML Priority', 'ML Confidence', 'LLM Priority', 'LLM Confidence', 'Final Priority', 'Ensemble Strategy', 'Triage Reason', 'Feedback Reason', 'Feedback Author', 'Created At'];
                const rows = logs.map(log => [
                    log.id,
                    log.ticket_id,
                    `"${(log.ticket_title || '').replace(/"/g, '""')}"`,
                    log.priority_predicted || '',
                    log.priority_confidence !== null ? log.priority_confidence.toFixed(3) : '',
                    log.priority_llm_predicted || '',
                    log.priority_llm_confidence !== null ? log.priority_llm_confidence.toFixed(3) : '',
                    log.priority_final || '',
                    log.ensemble_strategy || '',
                    log.triage_reason || '',
                    `"${(log.priority_feedback_reason || '').replace(/"/g, '""')}"`,
                    log.priority_feedback_author ? log.priority_feedback_author.email : '',
                    new Date(log.created_at).toISOString()
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ml_logs_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }).catch(error => {
                alert(`Export failed: ${error.message}`);
            });
        }

        document.getElementById('apply-filters').addEventListener('click', loadLogs);
        document.getElementById('export-csv').addEventListener('click', exportToCSV);
        document.getElementById('logout-btn').addEventListener('click', (event) => {
            event.preventDefault();
            api.logout();
            window.location.href = 'login.html';
        });

        (async function init() {
            try {
                await loadCurrentUser();
                await loadLogs();
            } catch (error) {
                console.error('ML log page init failed:', error);
            }
        })();
    </script>
</body>
</html>

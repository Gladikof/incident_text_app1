<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Tickets - Service Desk</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">Service Desk</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="tickets.html" class="nav-link" style="color: var(--primary);">Tickets</a></li>
            <li><a href="board.html" class="nav-link">Board</a></li>
            <li><a href="analytics.html" class="nav-link">Analytics</a></li>
            <li id="admin-nav-users" style="display: none;"><a href="admin-users.html" class="nav-link">Users</a></li>
            <li id="admin-nav-departments" style="display: none;"><a href="admin-departments.html" class="nav-link">Departments</a></li>
            <li><a href="#" class="nav-link" id="user-name">...</a></li>
            <li><a href="#" class="nav-link" id="logout-btn">–í–∏—Ö—ñ–¥</a></li>
        </ul>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>–¢—ñ–∫–µ—Ç–∏</h1>
            <a href="create-ticket.html" class="btn btn-primary">
                ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—ñ–∫–µ—Ç
            </a>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select id="filter-status" class="form-input">
                        <option value="">–í—Å—ñ</option>
                        <option value="NEW">NEW</option>
                        <option value="TRIAGE">TRIAGE</option>
                        <option value="IN_PROGRESS">IN_PROGRESS</option>
                        <option value="RESOLVED">RESOLVED</option>
                        <option value="CLOSED">CLOSED</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="filter-priority" class="form-input">
                        <option value="">–í—Å—ñ</option>
                        <option value="P1">P1 - –ö—Ä–∏—Ç–∏—á–Ω–∏–π</option>
                        <option value="P2">P2 - –í–∏—Å–æ–∫–∏–π</option>
                        <option value="P3">P3 - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">–¢—ñ–ª—å–∫–∏ —Ç—Ä—ñ–∞–∂</label>
                    <input type="checkbox" id="filter-triage" style="width: auto; margin-top: 0.5rem;">
                </div>
            </div>
        </div>

        <!-- Tickets Table -->
        <div class="card">
            <div id="loading" style="text-align: center; padding: 2rem; color: var(--gray-light);">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—ñ–≤...
            </div>

            <div id="tickets-container" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (ML)</th>
                            <th>–¢—Ä—ñ–∞–∂</th>
                            <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-tbody">
                    </tbody>
                </table>
            </div>

            <div id="empty-state" style="display: none; text-align: center; padding: 3rem; color: var(--gray-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <div>–¢—ñ–∫–µ—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div id="ticket-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="modal-title" style="margin: 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h2>
                <button id="close-modal" class="btn" style="background: transparent; padding: 0.5rem;">&times;</button>
            </div>

            <div id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="js/api.v2.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const currentUser = user; // Alias for consistency
        document.getElementById('user-name').textContent = user.email || 'User';

        // Show admin links if user is ADMIN
        if (user.role === 'ADMIN') {
            document.getElementById('admin-nav-users').style.display = 'block';
            document.getElementById('admin-nav-departments').style.display = 'block';
        }

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            api.logout();
            window.location.href = 'login.html';
        });

        // –°—Ç–∞—Ç—É—Å badges
        const statusBadges = {
            'NEW': '<span class="badge" style="background: #1e3a8a; color: #93c5fd;">NEW</span>',
            'TRIAGE': '<span class="badge" style="background: #78350f; color: #fde047;">TRIAGE</span>',
            'IN_PROGRESS': '<span class="badge" style="background: #065f46; color: #86efac;">IN_PROGRESS</span>',
            'RESOLVED': '<span class="badge" style="background: #1e40af; color: #93c5fd;">RESOLVED</span>',
            'CLOSED': '<span class="badge" style="background: #374151; color: #9ca3af;">CLOSED</span>',
        };

        const priorityBadges = {
            'P1': '<span class="badge badge-p1">P1</span>',
            'P2': '<span class="badge badge-p2">P2</span>',
            'P3': '<span class="badge badge-p3">P3</span>',
        };

        // Load tickets
        async function loadTickets() {
            try {
                const filters = {};
                const status = document.getElementById('filter-status').value;
                const priority = document.getElementById('filter-priority').value;
                const triageOnly = document.getElementById('filter-triage').checked;

                if (status) filters.status = status;
                if (priority) filters.priority = priority;
                if (triageOnly) filters.triage_required = true;

                const tickets = await api.getTickets(filters);

                const tbody = document.getElementById('tickets-tbody');
                tbody.innerHTML = '';

                if (tickets.length === 0) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('tickets-container').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'block';
                    return;
                }

                tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openTicketModal(ticket.id);

                    const mlCategory = ticket.category_ml_suggested
                        ? `${ticket.category_ml_suggested} (${Math.round(ticket.category_ml_confidence * 100)}%)`
                        : '-';

                    const triageBadge = ticket.triage_required
                        ? '<span class="badge" style="background: #dc2626; color: white;">–ü–æ—Ç—Ä—ñ–±–µ–Ω</span>'
                        : '<span class="badge" style="background: #16a34a; color: white;">–ù—ñ</span>';

                    const createdDate = new Date(ticket.created_at).toLocaleDateString('uk-UA', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    row.innerHTML = `
                        <td><strong>${ticket.incident_id}</strong></td>
                        <td>${ticket.title}</td>
                        <td>${statusBadges[ticket.status] || ticket.status}</td>
                        <td>${priorityBadges[ticket.priority_manual] || ticket.priority_manual}</td>
                        <td>${mlCategory}</td>
                        <td>${triageBadge}</td>
                        <td style="color: var(--gray-light); font-size: 0.875rem;">${createdDate}</td>
                    `;

                    tbody.appendChild(row);
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('tickets-container').style.display = 'block';
                document.getElementById('empty-state').style.display = 'none';

            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('loading').innerHTML =
                    '<div style="color: var(--danger);">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + error.message + '</div>';
            }
        }

        // Filters
        document.getElementById('filter-status').addEventListener('change', loadTickets);
        document.getElementById('filter-priority').addEventListener('change', loadTickets);
        document.getElementById('filter-triage').addEventListener('change', loadTickets);

        // Modal functionality
        const modal = document.getElementById('ticket-modal');
        const closeModalBtn = document.getElementById('close-modal');

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        async function openTicketModal(ticketId) {
            modal.style.display = 'flex';
            document.getElementById('modal-title').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            document.getElementById('modal-body').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-light);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>';

            try {
                const ticket = await api.getTicket(ticketId);
                renderTicketDetails(ticket);
            } catch (error) {
                console.error('Error loading ticket:', error);
                document.getElementById('modal-body').innerHTML =
                    '<div style="color: var(--danger); padding: 2rem;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + error.message + '</div>';
            }
        }

        function renderTicketDetails(ticket) {
            document.getElementById('modal-title').textContent = ticket.incident_id;

            const createdDate = new Date(ticket.created_at).toLocaleString('uk-UA');
            const updatedDate = new Date(ticket.updated_at).toLocaleString('uk-UA');

            // ML badges
            const priorityML = ticket.priority_ml_suggested
                ? `<div style="margin-bottom: 0.5rem;">
                     <span class="badge badge-${ticket.priority_ml_suggested.toLowerCase()}">${ticket.priority_ml_suggested}</span>
                     <span class="badge" style="background: #1e3a8a; color: #93c5fd; margin-left: 0.5rem;">
                       ${Math.round(ticket.priority_ml_confidence * 100)}% confidence
                     </span>
                   </div>`
                : '<div style="color: var(--gray-light); font-size: 0.875rem;">ML –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ</div>';

            const categoryML = ticket.category_ml_suggested
                ? `<div style="margin-bottom: 0.5rem;">
                     <span class="badge" style="background: #065f46; color: #86efac;">${ticket.category_ml_suggested}</span>
                     <span class="badge" style="background: #1e3a8a; color: #93c5fd; margin-left: 0.5rem;">
                       ${Math.round(ticket.category_ml_confidence * 100)}% confidence
                     </span>
                   </div>`
                : '<div style="color: var(--gray-light); font-size: 0.875rem;">ML –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ</div>';

            const triageBadge = ticket.triage_required
                ? '<span class="badge" style="background: #dc2626; color: white;">–ü–æ—Ç—Ä—ñ–±–µ–Ω —Ç—Ä—ñ–∞–∂</span>'
                : '<span class="badge" style="background: #16a34a; color: white;">–¢—Ä—ñ–∞–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω</span>';

            // Action buttons based on status and user role
            let actionButtons = '';
            if (ticket.status === 'NEW' || ticket.status === 'TRIAGE') {
                actionButtons += `
                    <button onclick="claimTicket(${ticket.id})" class="btn btn-primary" style="margin-right: 0.5rem;">
                        üôã –í–∑—è—Ç–∏ —Ç—ñ–∫–µ—Ç
                    </button>
                `;
            }

            // Status change dropdown
            const statusOptions = ['NEW', 'TRIAGE', 'IN_PROGRESS', 'RESOLVED', 'CLOSED'];
            const statusDropdown = `
                <select id="status-change" class="form-input" style="width: auto; display: inline-block; margin-right: 0.5rem;">
                    ${statusOptions.map(s => `<option value="${s}" ${s === ticket.status ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
                <button onclick="updateStatus(${ticket.id})" class="btn" style="background: var(--primary);">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å
                </button>
            `;

            const priorityOptions = ['P1', 'P2', 'P3'];
            const priorityDropdown = `
                        <select id="priority-change" class="form-input" style="width: auto; display: inline-block; margin-right: 0.5rem;" data-current-priority="${ticket.priority_manual}">
                    ${priorityOptions.map(p => `<option value="${p}" ${p === ticket.priority_manual ? 'selected' : ''}>${p}</option>`).join('')}
                </select>
                <button onclick="updatePriority(${ticket.id})" class="btn" style="background: var(--primary);">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
                </button>
            `;

            const modalContent = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Title -->
                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                        <div style="font-size: 1.125rem; font-weight: 600;">${ticket.title}</div>
                    </div>

                    <!-- Description -->
                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–û–ø–∏—Å</h3>
                        <div style="white-space: pre-wrap;">${ticket.description}</div>
                    </div>

                    <!-- Status & Priority -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–°—Ç–∞—Ç—É—Å</h3>
                            ${statusBadges[ticket.status] || ticket.status}
                            <div style="margin-top: 1rem;">
                                ${statusDropdown}
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (Manual)</h3>
                            ${priorityBadges[ticket.priority_manual] || ticket.priority_manual}
                            <div style="margin-top: 1rem;">
                                ${priorityDropdown}
                            </div>
                        </div>
                    </div>

                    <!-- ML Predictions -->
                    <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">ü§ñ ML Predictions</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (ML)</h4>
                                ${priorityML}
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (ML)</h4>
                                ${categoryML}
                            </div>
                        </div>
                    </div>

                    <!-- Triage -->
                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–¢—Ä—ñ–∞–∂</h3>
                        ${triageBadge}
                        ${ticket.triage_note ? `<div style="margin-top: 0.5rem; color: var(--gray-light); font-size: 0.875rem;">${ticket.triage_note}</div>` : ''}
                    </div>

                    <!-- Metadata -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem; color: var(--gray-light);">
                        <div>
                            <strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> ${createdDate}
                        </div>
                        <div>
                            <strong>–û–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${updatedDate}
                        </div>
                        <div>
                            <strong>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</strong> ${ticket.department ? ticket.department.name : 'N/A'}
                        </div>
                        <div>
                            <strong>–í–∏–∫–æ–Ω–∞–≤—Ü—ñ:</strong>
                            ${ticket.assignees && ticket.assignees.length > 0
                                ? ticket.assignees.map(a => a.email || a.full_name).join(', ')
                                : (ticket.assigned_to ? ticket.assigned_to.email : '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ')
                            }
                            ${ticket.auto_assigned && ticket.assignment_confirmed === null ?
                                '<span style="color: var(--warning); margin-left: 0.5rem;">(–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)</span>' : ''}
                            ${ticket.auto_assigned && ticket.assignment_confirmed === true ?
                                '<span style="color: var(--success); margin-left: 0.5rem;">(–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ)</span>' : ''}
                            ${ticket.auto_assigned && ticket.assignment_confirmed === false ?
                                '<span style="color: var(--danger); margin-left: 0.5rem;">(–≤—ñ–¥—Ö–∏–ª–µ–Ω–æ)</span>' : ''}
                        </div>
                    </div>

                    <!-- Manual Assignment (for LEAD/ADMIN) -->
                    ${(currentUser.role === 'LEAD' || currentUser.role === 'ADMIN') ? `
                        <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; font-weight: 600;">üë• –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ–≤</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label class="form-label" style="display: block; margin-bottom: 0.5rem;">1. –û–±–µ—Ä—ñ—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                                    <select id="department-select-${ticket.id}" class="form-input" style="width: 100%;" onchange="loadAgentsByDepartment(${ticket.id})">
                                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="display: block; margin-bottom: 0.5rem;">2. –û–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç—ñ–≤ (–º–æ–∂–Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞):</label>
                                    <select id="assignee-select-${ticket.id}" class="form-input" style="width: 100%; min-height: 80px;" multiple disabled>
                                        <option value="">-- –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>
                                    </select>
                                    <small style="display: block; margin-top: 0.25rem; color: var(--gray-light);">–£—Ç—Ä–∏–º—É–π—Ç–µ Ctrl/Cmd –¥–ª—è –≤–∏–±–æ—Ä—É –¥–µ–∫—ñ–ª—å–∫–æ—Ö</small>
                                </div>
                            </div>
                            <button onclick="assignMultipleAssignees(${ticket.id})" class="btn btn-primary" style="width: 100%;">
                                –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ–≤
                            </button>
                        </div>
                    ` : ''}

                    <!-- Assignment Confirmation (if auto-assigned and not confirmed yet) -->
                    ${ticket.auto_assigned && ticket.assignment_confirmed === null && ticket.assigned_to && ticket.assigned_to.id === currentUser.id ? `
                        <div style="background: var(--warning-bg, #2d2a1a); border: 1px solid var(--warning); border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--warning);">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</h4>
                            <p style="margin: 0 0 1rem 0; font-size: 0.875rem;">
                                –¶–µ–π —Ç—ñ–∫–µ—Ç –±—É–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –≤–∞–º. –ß–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤—ñ–Ω –≤–∞—à—ñ–π —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó?
                            </p>
                            <textarea id="assignment-feedback" placeholder="–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –∫–æ–º–µ–Ω—Ç–∞—Ä –ø—Ä–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è"
                                style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); color: var(--text); border-radius: 4px; margin-bottom: 0.75rem; font-family: inherit;"></textarea>
                            <div style="display: flex; gap: 0.75rem;">
                                <button onclick="confirmAssignment(${ticket.id}, true)" class="btn btn-success" style="flex: 1;">
                                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é (–º—ñ–π –≤—ñ–¥–¥—ñ–ª)
                                </button>
                                <button onclick="confirmAssignment(${ticket.id}, false)" class="btn btn-danger" style="flex: 1;">
                                    –í—ñ–¥—Ö–∏–ª—è—é (–Ω–µ –º–æ—è —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è)
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Action Buttons -->
                    ${actionButtons ? `<div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">${actionButtons}</div>` : ''}
                </div>
            `;

            document.getElementById('modal-body').innerHTML = modalContent;

            // Load departments list for assignment dropdown (if visible)
            if (currentUser.role === 'LEAD' || currentUser.role === 'ADMIN') {
                loadDepartmentsForAssignment(ticket.id);
            }
        }

        async function claimTicket(ticketId) {
            try {
                await api.claimTicket(ticketId);
                alert('–¢—ñ–∫–µ—Ç —É—Å–ø—ñ—à–Ω–æ –≤–∑—è—Ç–æ!');
                closeModal();
                loadTickets(); // Reload list
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function updateStatus(ticketId) {
            const newStatus = document.getElementById('status-change').value;
            try {
                await api.updateTicket(ticketId, { status: newStatus });
                alert('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                await openTicketModal(ticketId); // Reload modal
                loadTickets(); // Reload list
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function updatePriority(ticketId) {
            const prioritySelect = document.getElementById('priority-change');
            const newPriority = prioritySelect.value;
            const currentPriority = prioritySelect.dataset.currentPriority;
            if (newPriority === currentPriority) {
                alert('–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è.');
                return;
            }

            const reason = prompt('–ü–æ—è—Å–Ω—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –∑–º—ñ–Ω–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É:', '');
            if (!reason || reason.trim().length < 3) {
                alert('–ü–æ—è—Å–Ω–µ–Ω–Ω—è –æ–±–æ–≤\'—è–∑–∫–æ–≤–µ —ñ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 3 —Å–∏–º–≤–æ–ª–∏.');
                return;
            }

            try {
                await api.updateTicket(ticketId, {
                    priority_manual: newPriority,
                    priority_manual_reason: reason.trim(),
                });
                alert('–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                await openTicketModal(ticketId); // Reload modal
                loadTickets(); // Reload list
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function loadDepartmentsForAssignment(ticketId) {
            console.log('[DEBUG] loadDepartmentsForAssignment called for ticket:', ticketId);
            console.log('[DEBUG] API_BASE_URL:', API_BASE_URL);
            console.log('[DEBUG] Token exists:', !!localStorage.getItem('token'));

            try {
                // Fetch all departments
                const url = `${API_BASE_URL}/departments`;
                console.log('[DEBUG] Fetching departments from:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('[DEBUG] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[DEBUG] Error response:', errorText);
                    throw new Error('Failed to load departments: ' + response.status);
                }

                const departments = await response.json();
                console.log('[DEBUG] Departments loaded:', departments.length, departments);

                // Populate department dropdown
                const deptSelect = document.getElementById(`department-select-${ticketId}`);
                console.log('[DEBUG] Department select element:', deptSelect);

                if (deptSelect) {
                    // Clear existing options except first
                    deptSelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>';

                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        deptSelect.appendChild(option);
                    });

                    console.log('[DEBUG] Department dropdown populated with', departments.length, 'departments');
                }
            } catch (error) {
                console.error('[ERROR] Failed to load departments:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ñ–≤: ' + error.message);
            }
        }

        async function loadAgentsByDepartment(ticketId) {
            const deptSelect = document.getElementById(`department-select-${ticketId}`);
            const deptId = deptSelect?.value;
            const agentSelect = document.getElementById(`assignee-select-${ticketId}`);

            if (!agentSelect) return;

            // Clear and disable if no department selected
            if (!deptId) {
                agentSelect.innerHTML = '<option value="">-- –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>';
                agentSelect.disabled = true;
                return;
            }

            try {
                // Fetch all users
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load agents');

                const users = await response.json();

                // Filter agents by selected department and active status
                const agents = users.filter(u =>
                    (u.role === 'AGENT' || u.role === 'LEAD') &&
                    u.is_active &&
                    u.department_id === parseInt(deptId)
                );

                // Populate agent dropdown
                agentSelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞ --</option>';

                if (agents.length === 0) {
                    agentSelect.innerHTML = '<option value="">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç—ñ–≤ —É —Ü—å–æ–º—É –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ñ</option>';
                    agentSelect.disabled = true;
                } else {
                    agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.full_name || agent.email} (${agent.role})${agent.specialty ? ' - ' + agent.specialty : ''}`;
                        agentSelect.appendChild(option);
                    });
                    agentSelect.disabled = false;
                }
            } catch (error) {
                console.error('Failed to load agents:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç—ñ–≤: ' + error.message);
            }
        }

        async function assignTicket(ticketId) {
            const select = document.getElementById(`assignee-select-${ticketId}`);
            const assigneeId = select?.value;

            if (!assigneeId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}/assign`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assigned_to_user_id: parseInt(assigneeId)
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to assign ticket');
                }

                alert('–¢—ñ–∫–µ—Ç —É—Å–ø—ñ—à–Ω–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ!');
                closeModal();
                loadTickets(); // Reload list
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function assignMultipleAssignees(ticketId) {
            const select = document.getElementById(`assignee-select-${ticketId}`);
            const selectedOptions = Array.from(select.selectedOptions);
            const assigneeIds = selectedOptions.map(opt => parseInt(opt.value)).filter(id => !isNaN(id));

            console.log('[DEBUG] assignMultipleAssignees called for ticket:', ticketId);
            console.log('[DEBUG] Selected assignee IDs:', assigneeIds);

            if (assigneeIds.length === 0) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–æ–≥–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞');
                return;
            }

            try {
                const url = `${API_BASE_URL}/tickets/${ticketId}/assignees`;
                console.log('[DEBUG] POST request to:', url);
                console.log('[DEBUG] Request body:', { assignee_ids: assigneeIds });

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assignee_ids: assigneeIds
                    })
                });

                console.log('[DEBUG] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[DEBUG] Error response:', errorText);
                    let errorDetail = 'Failed to assign ticket';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorDetail = errorJson.detail || errorDetail;
                    } catch (e) {
                        errorDetail = errorText || errorDetail;
                    }
                    throw new Error(errorDetail);
                }

                const result = await response.json();
                console.log('[DEBUG] Assignment successful:', result);

                alert(`–¢—ñ–∫–µ—Ç —É—Å–ø—ñ—à–Ω–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ ${assigneeIds.length} –≤–∏–∫–æ–Ω–∞–≤—Ü—è–º!`);
                closeModal();
                loadTickets(); // Reload list
            } catch (error) {
                console.error('[ERROR] Failed to assign:', error);
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function confirmAssignment(ticketId, confirmed) {
            const feedback = document.getElementById('assignment-feedback')?.value || null;

            try {
                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}/assignment/confirm?confirmed=${confirmed}&feedback=${encodeURIComponent(feedback || '')}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to confirm assignment');
                }

                const result = await response.json();
                alert(result.message);
                closeModal();
                loadTickets(); // Reload list
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        // Initial load
        loadTickets();
    </script>
</body>
</html>

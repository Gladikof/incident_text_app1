<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board - Service Desk</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .board-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .board-column {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            min-height: 500px;
        }

        .column-header {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ticket-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .ticket-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .ticket-card-id {
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .ticket-card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">Service Desk</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="tickets.html" class="nav-link">Tickets</a></li>
            <li><a href="board.html" class="nav-link" style="color: var(--primary);">Board</a></li>
            <li><a href="analytics.html" class="nav-link">Analytics</a></li>
            <li id="ml-logs-nav" style="display: none;"><a href="ml-logs.html" class="nav-link">ML Logs</a></li>
            <li id="ml-training-nav" style="display: none;"><a href="ml-training.html" class="nav-link">ML Training</a></li>
            <li id="admin-nav-users" style="display: none;"><a href="admin-users.html" class="nav-link">Users</a></li>
            <li id="admin-nav-departments" style="display: none;"><a href="admin-departments.html" class="nav-link">Departments</a></li>
            <li><a href="#" class="nav-link" id="user-name">...</a></li>
            <li><a href="#" class="nav-link" id="logout-btn">–í–∏—Ö—ñ–¥</a></li>
        </ul>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1>Kanban Board</h1>
            <a href="create-ticket.html" class="btn btn-primary">
                ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—ñ–∫–µ—Ç
            </a>
        </div>

        <!-- Filters -->
        <div class="card filter-bar">
            <div>
                <label class="form-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label>
                <select id="filter-priority" class="form-input" style="width: 150px;">
                    <option value="">–í—Å—ñ</option>
                    <option value="P1">P1</option>
                    <option value="P2">P2</option>
                    <option value="P3">P3</option>
                </select>
            </div>
            <div>
                <label class="form-label">–¢—ñ–ª—å–∫–∏ —Ç—Ä—ñ–∞–∂</label>
                <input type="checkbox" id="filter-triage" style="width: auto; margin-top: 0.5rem;">
            </div>
        </div>

        <!-- Board -->
        <div id="board-loading" style="text-align: center; padding: 3rem; color: var(--gray-light);">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>

        <div id="board-container" class="board-container" style="display: none;">
            <div class="board-column">
                <div class="column-header">
                    <span style="color: #93c5fd;">üÜï NEW</span>
                    <span id="count-NEW" class="badge" style="background: #1e3a8a;">0</span>
                </div>
                <div id="column-NEW" class="column-cards"></div>
            </div>

            <div class="board-column">
                <div class="column-header">
                    <span style="color: #fde047;">‚ö†Ô∏è TRIAGE</span>
                    <span id="count-TRIAGE" class="badge" style="background: #78350f;">0</span>
                </div>
                <div id="column-TRIAGE" class="column-cards"></div>
            </div>

            <div class="board-column">
                <div class="column-header">
                    <span style="color: #86efac;">üîß IN PROGRESS</span>
                    <span id="count-IN_PROGRESS" class="badge" style="background: #065f46;">0</span>
                </div>
                <div id="column-IN_PROGRESS" class="column-cards"></div>
            </div>

            <div class="board-column">
                <div class="column-header">
                    <span style="color: #93c5fd;">‚úÖ RESOLVED</span>
                    <span id="count-RESOLVED" class="badge" style="background: #1e40af;">0</span>
                </div>
                <div id="column-RESOLVED" class="column-cards"></div>
            </div>

            <div class="board-column">
                <div class="column-header">
                    <span style="color: #9ca3af;">üîí CLOSED</span>
                    <span id="count-CLOSED" class="badge" style="background: #374151;">0</span>
                </div>
                <div id="column-CLOSED" class="column-cards"></div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal (same as tickets.html) -->
    <div id="ticket-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="modal-title" style="margin: 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h2>
                <button id="close-modal" class="btn" style="background: transparent; padding: 0.5rem; font-size: 2rem;">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="js/api.v2.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('user-name').textContent = user.email || 'User';

        // Show admin links if user is ADMIN
        if (user.role === 'ADMIN') {
            document.getElementById('admin-nav-users').style.display = 'block';
            document.getElementById('admin-nav-departments').style.display = 'block';
        }

        // Show ML Logs for LEAD and ADMIN
        if (user.role === 'LEAD' || user.role === 'ADMIN') {
            document.getElementById('ml-logs-nav').style.display = 'block';
        }

        // Show ML Training for ADMIN only
        if (user.role === 'ADMIN') {
            document.getElementById('ml-training-nav').style.display = 'block';
        }

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            api.logout();
            window.location.href = 'login.html';
        });

        const statusBadges = {
            'NEW': '<span class="badge" style="background: #1e3a8a; color: #93c5fd;">NEW</span>',
            'TRIAGE': '<span class="badge" style="background: #78350f; color: #fde047;">TRIAGE</span>',
            'IN_PROGRESS': '<span class="badge" style="background: #065f46; color: #86efac;">IN_PROGRESS</span>',
            'RESOLVED': '<span class="badge" style="background: #1e40af; color: #93c5fd;">RESOLVED</span>',
            'CLOSED': '<span class="badge" style="background: #374151; color: #9ca3af;">CLOSED</span>',
        };

        const priorityBadges = {
            'P1': '<span class="badge badge-p1">P1</span>',
            'P2': '<span class="badge badge-p2">P2</span>',
            'P3': '<span class="badge badge-p3">P3</span>',
        };

        // Load board
        async function loadBoard() {
            try {
                const filters = {};
                const priority = document.getElementById('filter-priority').value;
                const triageOnly = document.getElementById('filter-triage').checked;

                if (priority) filters.priority = priority;
                if (triageOnly) filters.triage_required = true;

                const tickets = await api.getTickets(filters);

                // Clear columns
                const statuses = ['NEW', 'TRIAGE', 'IN_PROGRESS', 'RESOLVED', 'CLOSED'];
                statuses.forEach(status => {
                    document.getElementById(`column-${status}`).innerHTML = '';
                    document.getElementById(`count-${status}`).textContent = '0';
                });

                // Group by status
                const grouped = {};
                statuses.forEach(s => grouped[s] = []);
                tickets.forEach(ticket => {
                    if (grouped[ticket.status]) {
                        grouped[ticket.status].push(ticket);
                    }
                });

                // Render cards
                Object.keys(grouped).forEach(status => {
                    const column = document.getElementById(`column-${status}`);
                    const count = document.getElementById(`count-${status}`);
                    const ticketsInColumn = grouped[status];

                    count.textContent = ticketsInColumn.length;

                    ticketsInColumn.forEach(ticket => {
                        const card = document.createElement('div');
                        card.className = 'ticket-card';
                        card.onclick = () => openTicketModal(ticket.id);

                        const mlBadge = ticket.category_ml_suggested
                            ? `<span class="badge" style="background: #065f46; color: #86efac; font-size: 0.7rem;">
                                 ${ticket.category_ml_suggested} ${Math.round(ticket.category_ml_confidence * 100)}%
                               </span>`
                            : '';

                        const triageBadge = ticket.triage_required
                            ? '<span class="badge" style="background: #dc2626; color: white; font-size: 0.7rem;">–¢—Ä—ñ–∞–∂</span>'
                            : '';

                        card.innerHTML = `
                            <div class="ticket-card-id">${ticket.incident_id}</div>
                            <div class="ticket-card-title">${ticket.title}</div>
                            <div class="ticket-card-badges">
                                ${priorityBadges[ticket.priority_manual] || ''}
                                ${mlBadge}
                                ${triageBadge}
                            </div>
                        `;

                        column.appendChild(card);
                    });

                    if (ticketsInColumn.length === 0) {
                        column.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-light); font-size: 0.875rem;">–ù–µ–º–∞—î —Ç—ñ–∫–µ—Ç—ñ–≤</div>';
                    }
                });

                document.getElementById('board-loading').style.display = 'none';
                document.getElementById('board-container').style.display = 'grid';

            } catch (error) {
                console.error('Error loading board:', error);
                document.getElementById('board-loading').innerHTML =
                    '<div style="color: var(--danger);">–ü–æ–º–∏–ª–∫–∞: ' + error.message + '</div>';
            }
        }

        // Filters
        document.getElementById('filter-priority').addEventListener('change', loadBoard);
        document.getElementById('filter-triage').addEventListener('change', loadBoard);

        // Modal functionality (same as tickets.html)
        const modal = document.getElementById('ticket-modal');
        const closeModalBtn = document.getElementById('close-modal');

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        async function openTicketModal(ticketId) {
            modal.style.display = 'flex';
            document.getElementById('modal-title').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            document.getElementById('modal-body').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-light);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>';

            try {
                const ticket = await api.getTicket(ticketId);
                renderTicketDetails(ticket);
            } catch (error) {
                console.error('Error loading ticket:', error);
                document.getElementById('modal-body').innerHTML =
                    '<div style="color: var(--danger); padding: 2rem;">–ü–æ–º–∏–ª–∫–∞: ' + error.message + '</div>';
            }
        }

        function renderTicketDetails(ticket) {
            document.getElementById('modal-title').textContent = ticket.incident_id;

            const createdDate = new Date(ticket.created_at).toLocaleString('uk-UA');
            const updatedDate = new Date(ticket.updated_at).toLocaleString('uk-UA');

            const priorityML = ticket.priority_ml_suggested
                ? `<div style="margin-bottom: 0.5rem;">
                     <span class="badge badge-${ticket.priority_ml_suggested.toLowerCase()}">${ticket.priority_ml_suggested}</span>
                     <span class="badge" style="background: #1e3a8a; color: #93c5fd; margin-left: 0.5rem;">
                       ${Math.round(ticket.priority_ml_confidence * 100)}% confidence
                     </span>
                   </div>`
                : '<div style="color: var(--gray-light); font-size: 0.875rem;">ML –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ</div>';

            const categoryML = ticket.category_ml_suggested
                ? `<div style="margin-bottom: 0.5rem;">
                     <span class="badge" style="background: #065f46; color: #86efac;">${ticket.category_ml_suggested}</span>
                     <span class="badge" style="background: #1e3a8a; color: #93c5fd; margin-left: 0.5rem;">
                       ${Math.round(ticket.category_ml_confidence * 100)}% confidence
                     </span>
                   </div>`
                : '<div style="color: var(--gray-light); font-size: 0.875rem;">ML –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ</div>';

            const triageBadge = ticket.triage_required
                ? '<span class="badge" style="background: #dc2626; color: white;">–ü–æ—Ç—Ä—ñ–±–µ–Ω —Ç—Ä—ñ–∞–∂</span>'
                : '<span class="badge" style="background: #16a34a; color: white;">–¢—Ä—ñ–∞–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω</span>';

            let actionButtons = '';
            if (ticket.status === 'NEW' || ticket.status === 'TRIAGE') {
                actionButtons += `
                    <button onclick="claimTicket(${ticket.id})" class="btn btn-primary" style="margin-right: 0.5rem;">
                        üôã –í–∑—è—Ç–∏ —Ç—ñ–∫–µ—Ç
                    </button>
                `;
            }

            const statusOptions = ['NEW', 'TRIAGE', 'IN_PROGRESS', 'RESOLVED', 'CLOSED'];
            const statusDropdown = `
                <select id="status-change" class="form-input" style="width: auto; display: inline-block; margin-right: 0.5rem;">
                    ${statusOptions.map(s => `<option value="${s}" ${s === ticket.status ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
                <button onclick="updateStatus(${ticket.id})" class="btn" style="background: var(--primary);">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å
                </button>
            `;

            const priorityOptions = ['P1', 'P2', 'P3'];
            const priorityDropdown = `
                <select id="priority-change" class="form-input" style="width: auto; display: inline-block; margin-right: 0.5rem;">
                    ${priorityOptions.map(p => `<option value="${p}" ${p === ticket.priority_manual ? 'selected' : ''}>${p}</option>`).join('')}
                </select>
                <button onclick="updatePriority(${ticket.id})" class="btn" style="background: var(--primary);">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
                </button>
            `;

            const modalContent = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                        <div style="font-size: 1.125rem; font-weight: 600;">${ticket.title}</div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–û–ø–∏—Å</h3>
                        <div style="white-space: pre-wrap;">${ticket.description}</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–°—Ç–∞—Ç—É—Å</h3>
                            ${statusBadges[ticket.status] || ticket.status}
                            <div style="margin-top: 1rem;">
                                ${statusDropdown}
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (Manual)</h3>
                            ${priorityBadges[ticket.priority_manual] || ticket.priority_manual}
                            <div style="margin-top: 1rem;">
                                ${priorityDropdown}
                            </div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">ü§ñ ML Predictions</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç (ML)</h4>
                                ${priorityML}
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (ML)</h4>
                                ${categoryML}
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-light); font-size: 0.875rem; font-weight: 500;">–¢—Ä—ñ–∞–∂</h3>
                        ${triageBadge}
                        ${ticket.triage_note ? `<div style="margin-top: 0.5rem; color: var(--gray-light); font-size: 0.875rem;">${ticket.triage_note}</div>` : ''}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem; color: var(--gray-light);">
                        <div>
                            <strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> ${createdDate}
                        </div>
                        <div>
                            <strong>–û–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${updatedDate}
                        </div>
                        <div>
                            <strong>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</strong> ${ticket.department ? ticket.department.name : 'N/A'}
                        </div>
                        <div>
                            <strong>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</strong> ${ticket.agent ? ticket.agent.email : '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ'}
                        </div>
                    </div>

                    ${actionButtons ? `<div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">${actionButtons}</div>` : ''}
                </div>
            `;

            document.getElementById('modal-body').innerHTML = modalContent;
        }

        async function claimTicket(ticketId) {
            try {
                await api.claimTicket(ticketId);
                alert('–¢—ñ–∫–µ—Ç —É—Å–ø—ñ—à–Ω–æ –≤–∑—è—Ç–æ!');
                closeModal();
                loadBoard();
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function updateStatus(ticketId) {
            const newStatus = document.getElementById('status-change').value;
            try {
                await api.updateTicket(ticketId, { status: newStatus });
                alert('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                await openTicketModal(ticketId);
                loadBoard();
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function updatePriority(ticketId) {
            const newPriority = document.getElementById('priority-change').value;
            try {
                await api.updateTicket(ticketId, { priority_manual: newPriority });
                alert('–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                await openTicketModal(ticketId);
                loadBoard();
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        // Initial load
        loadBoard();
    </script>
</body>
</html>
